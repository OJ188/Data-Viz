---
title: "Weed Veez"
output:
  html_document:
    toc: TRUE
    code_folding : "hide"
    number_sections : TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, fig.align="center", error=FALSE, message = FALSE)
```

Weed trading has a very large number in the United States. This paper attempts to explore the trends and influencing factors of weed transactions through changes in the price of weed (high,medium and low quality) in the US states in 2014-2017.
![](0r6ahsjpxev5lmgp.png)

```{r libraries, message=FALSE,eval=TRUE}
library(treemap)
library(zoo)
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(DT)
library(viridis)
library(plotly)
library(tidyverse)
library(dygraphs)
library(xts)          # To make the convertion data-frame / xts format
library(lubridate)
```


#Comparison of weed transaction prices in US states in 2014

```{r opening file}

###### OPENING FILE
df = read.table("Weed_Price.csv",header=TRUE,sep=",",dec=".",stringsAsFactors = TRUE)
attach(df)
date <- as.Date(date)

###### COMPLETING MISSING VALUES WITH LAST NONE NA VALUE
df = df[with(df, order(State,date)),]
df = na.locf(df)

```

First, let’s take a look at the weed prices of the states in 2014 (three different qualities)

```{r datatable, message=FALSE}
df1=read.table("Weed_Price.csv",header=TRUE,sep=",",dec=".")
df2=df1[c(1:51),]
df2$date <- as.Date(df2$date)
datatable(df2, rownames = FALSE, filter = "top", options = list(pagelength=5,scrollX=T))
```

Maybe the query form is not intuitive enough? So let's take a look at lollipop

```{r lollipop, message=FALSE}

###### Lollipop chart : Mean by state, HighQ, MedQ, LowQ and average

# 1) HighQ 2) MedQ 3) LowQ 4) Average of the 3
# Choix = 1
# Choix = 2
# Choix = 3
Choix = 4


if(Choix==1)
{
  Mean_state = data.frame(aggregate(HighQ~State, data=df, 
                                    FUN=function(df) c(mean=mean(df), count=length(df))))
  Mean_state$HighQ = Mean_state$HighQ[1:51]
  Mean_state=Mean_state[order(Mean_state[,2]),]
  Q = Mean_state$HighQ
  title = "High Quality"
}
if(Choix==2)
{
  Mean_state = data.frame(aggregate(MedQ~State, data=df, 
                                    FUN=function(df) c(mean=mean(df), count=length(df))))
  Mean_state$MedQ = Mean_state$MedQ[1:51]
  Mean_state=Mean_state[order(Mean_state[,2]),]
  Q = Mean_state$MedQ
  title = "Medium Quality"
} 
if(Choix==3)
{
  Mean_state = data.frame(aggregate(LowQ~State, data=df, 
                                    FUN=function(df) c(mean=mean(df), count=length(df))))
  Mean_state$LowQ = Mean_state$LowQ[1:51]
  Mean_state=Mean_state[order(Mean_state[,2]),]
  Q = Mean_state$LowQ
  title = "Low Quality"
}
if(Choix==4)
{
  Mean_state = data.frame(aggregate(
    (HighQ+MedQ+LowQ)/3~State, data=df, 
    FUN=function(df) c(mean=mean(df), count=length(df))))
  Mean_state$X.HighQ...MedQ...LowQ..3 = Mean_state$X.HighQ...MedQ...LowQ..3[1:51]
  Mean_state=Mean_state[order(Mean_state[,2]),]
  Q = Mean_state$X.HighQ...MedQ...LowQ..3
  title = "Average of the 3 qualities"
}


State = as.character(Mean_state$State)

label_max = paste(c(State[Q==max(Q)],":", ceiling(max(Q)),"$/oz."), collapse = " ")
label_mean = paste(c("Mean :", ceiling(mean(Q)),"$/oz."), collapse = " ")
label_min = paste(c(State[Q==min(Q)], ceiling(min(Q)),"$/oz."), collapse = " ")
label_median = paste(c("Median :", State[Q==median(Q)],"with", ceiling(median(Q)),"$/oz."), collapse = " ")
label_y = paste(c("Mean price per state :", title), collapse = " ")

Mean_state %>%
  arrange(Q) %>%
  mutate(State=factor(State,State)) %>%
  ggplot(aes(x=State, y=Q)) +
  geom_segment( aes(x=State, xend=State, y=0, yend=Q), 
                color=ifelse((State==State[Q==median(Q)]), "orange", "skyblue"), 
                  size=ifelse((State==State[Q==median(Q)]), 1.3, 0.7)) +
  geom_point( color=ifelse((State==State[Q==median(Q)]), "orange", "red"), 
              size=3, fill=alpha("orange", 0.3), alpha=0.7, shape=21, stroke=2) +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  ylab(label_y) +
  
  annotate("text", x=State[Q==max(Q)], y=max(Q) - 130,
           label=label_max, color="red") +
  annotate(geom="point", State[Q==max(Q)], y=max(Q), 
           shape=21, size=10, fill="transparent", color="red") +
  
  annotate("text", x=State[Q==min(Q)], y=150,
           label=label_min, color="red") +
  annotate(geom="point", State[Q==min(Q)], y=min(Q), 
           shape=21, size=10, fill="transparent", color="red") +
  
  geom_hline(yintercept=mean(Q), color="blue", size=.5) +
  annotate("text", x=State[Q==min(Q)], y=max(Q) - 90,
           label=label_mean, color="blue", size=4, fontface="bold") +
  
  annotate("text", x = State[Q==median(Q)], y = median(Q)*0.8, 
    label=label_median, color="black", size=4 , angle=0, fontface="bold", hjust=0)

```

Obviously, there is a large gap between the states' cannabis prices, which may be due to the laws of the states and the average income of the residents. . .
![](Marijuana-technology.jpg)

#Weed price trends (2014-2017)

Well, we all know that the legal restrictions on cannabis are gradually relaxed after 2014, so can the trend of price reflect the previous conjecture of impact factors?(Take Washington as an example)

```{r Price fluctuation, message=FALSE}
Washington = cbind.data.frame(as.Date(date[State=="Washington"]), 
                              HighQ[State=="Washington"])
Washington_names = c("Washington_date","Washington_HighQ")
names(Washington) = Washington_names
attach(Washington)
label_Washington = paste(c("Highest price in", "Washington : 1oz.",max(HighQ),"$"), 
                         collapse = " ")
label_dygraph = paste(c("Price fluctuation in Washington", 
                      collapse = " "))

don=xts(x = Washington_HighQ, order.by = Washington_date)
# graph
dygraph(don, main=label_dygraph) %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, 
            drawGrid = FALSE, colors="#D8AE5A") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, 
              hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)

```

It can be seen that the price of cannabis（weed) is generally on the rise.

Maybe Washington is a special case? Look again at Nevada！

```{r Nevada HighQN, message=FALSE}
#  Kangda graphs1(Tendance de la croissance Nevada HighQN)
df$date <- as.Date(df$date)
df %>%
  filter(State=="Nevada" ) %>%
  ggplot( aes(x=date, y=HighQN)) +
  geom_line()  
```

The price increase here is more obvious.
![](marijuana-memory-forget-bs-weedmemes.jpg)

#Comparison of different quality prices of cannabis in different states（High, Low, Medium)

```{r treemap , message=FALSE}
# treemap 2014-01-01
df1=read.table("Weed_Price.csv",header=TRUE,sep=",",dec=".")
df2=df1[c(1:51),]
df2$date <- as.Date(df2$date)


treemap(df2,
        index="State",
        vSize="HighQN",
        title="Treemap: HighQN of all the states in 2014-01-01",
        fontsize.title=12,
        cex = 0.5,
        type="index"
)
        
treemap(df2,
        index="State",
        vSize="LowQ",
        title="Treemap: LowQ of all the states in 2014-01-01",
        fontsize.title=12,
        cex = 0.5,
        type="index"
)

treemap(df2,
        index="State",
        vSize="HighQ",
        title="Treemap: HighQ of all the states in 2014-01-01",
        fontsize.title=12,
        cex = 0.5,
        type="index"
)

treemap(df2,
        index="State",
        vSize="MedQ",
        title="Treemap: MedQ of all the states in 2014-01-01",
        fontsize.title=12,
        cex = 0.5,
        type="index"
)
```
It can be seen that the price of low quality cannabis is close to always, and the higher the quality, the greater the price difference.

Therefore, we can make a reasonable inference: the premium attached to the price of cannabis is proportional to the quality.

#Map chart
Finally, we look at the deviation of the cannabis price in the same state through the map chart.
```{r map , message=FALSE}
###### US map (this code was shamefully copied from 
# https://plot.ly/r/choropleth-maps/)
# Showing mean of the 3 qualities and mean of each quality

# Reload to avoid problems
df = read.table("Weed_Price.csv",header=TRUE,sep=",",dec=".",stringsAsFactors = TRUE)
attach(df)
df = df[!(State =="District of Columbia"),]
State = unique(df$State)
date <- as.Date(date)

# COMPLETING MISSING VALUES WITH LAST NONE NA VALUE
df = df[with(df, order(State,df$date)),]
na.locf(df)

# Calculating means per state
Mean_state = data.frame(aggregate(df$HighQ~df$State, data=df, 
                                  FUN=function(df)
                                    c(mean=mean(df), count=length(df))))
HighQ = ceiling(Mean_state$df.HighQ[1:50])
Mean_state = data.frame(aggregate(df$MedQ~df$State, data=df, 
                                  FUN=function(df)
                                    c(mean=mean(df), count=length(df))))
MedQ = ceiling(Mean_state$df.MedQ[1:50])
Mean_state = data.frame(aggregate(df$LowQ~df$State, data=df, 
                                  FUN=function(df)
                                    c(mean=mean(df), count=length(df))))
LowQ = ceiling(Mean_state$df.LowQ[1:50])
Mean_state = data.frame(aggregate(
  (df$HighQ+df$MedQ+df$LowQ)/3~df$State, data=df, 
  FUN=function(df) c(mean=mean(df), count=length(df))))
MeanQ = ceiling(Mean_state$X.df.HighQ...df.MedQ...df.LowQ..3[1:50])


# Problem in State column with District of Columbia reappearing
df = df[!(State =="District of Columbia"),]
State = unique(df$State)

# Loading dataset from plotly
dfr <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")
dfr$hover = paste(State, "<br>", "High Quality", HighQ, "$,", 
                  "Medium Quality", MedQ, "$,",
                  "Low Quality", LowQ, "$")
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
# Ploting values
p <- plot_geo(dfr, locationmode = 'USA-states') %>%
  add_trace(
    z = ~MeanQ, text = ~hover, locations = ~code,
    color = ~MeanQ, colors = 'Purples'
  ) %>%
  colorbar(title = "$/oz.") %>%
  layout(
    title = 'Mean of weed prices per state ($/oz.)',
    geo = g
  )
p

```


![](weed leaf.png)

```{r violin , message=FALSE}
###### Violin plot
df %>%
  filter(State=="Alabama"|State=="Hawaii"|State=="Nevada")%>%
  ggplot(aes(x=State, y=HighQ, fill=State)) +
  geom_violin() +
  geom_jitter(color="grey", width=.2, size=.9, alpha=.8) +
  theme(
    legend.position = "none"
  ) +
  labs(title="Plotting every price submission per state") +
  ylab("Price per once") +
  coord_flip()
```